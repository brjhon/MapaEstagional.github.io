<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - Radares</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            flex-wrap: wrap;
            gap: 16px;
        }

        .header h1 {
            font-size: 32px;
            color: #22d3ee;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid #10b981;
            border-radius: 8px;
            font-size: 13px;
        }

        .sync-status.offline {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .sync-status.connecting {
            background: rgba(251, 191, 36, 0.2);
            border-color: #fbbf24;
            color: #fbbf24;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            background: #10b981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .sync-status.offline .sync-dot {
            background: #ef4444;
        }

        .sync-status.connecting .sync-dot {
            background: #fbbf24;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .btn-primary {
            background: #22d3ee;
            color: #000;
        }

        .btn-primary:hover {
            background: #06b6d4;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: #000;
        }

        .btn-success:hover {
            background: #059669;
        }

        .alert {
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.show {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            color: #10b981;
        }

        .alert-info {
            background: rgba(34, 211, 238, 0.2);
            border: 2px solid #22d3ee;
            color: #22d3ee;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1280px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .radar-preview {
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid #334155;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .radar-preview.active {
            border-color: #10b981;
            box-shadow: 0 0 30px rgba(16, 185, 129, 0.3);
        }

        .preview-header {
            padding: 16px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-title {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .badge {
            padding: 4px 12px;
            background: #10b981;
            color: #000;
            border-radius: 999px;
            font-size: 12px;
            font-weight: 700;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.online { background: #10b981; }
        .status-dot.loading { background: #fbbf24; }
        .status-dot.offline { background: #ef4444; }

        .iframe-container {
            height: 400px;
            background: #000;
            position: relative;
        }

        iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(16, 185, 129, 0.2);
            border-top-color: #10b981;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .preview-footer {
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            color: #fff;
            transition: all 0.2s;
            font-size: 16px;
        }

        .btn-icon:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.1);
        }

        .config-section {
            background: rgba(15, 23, 42, 0.5);
            border: 2px solid #334155;
            border-radius: 12px;
            padding: 24px;
            margin-top: 20px;
        }

        .config-section h3 {
            color: #22d3ee;
            margin-bottom: 16px;
            font-size: 18px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #cbd5e1;
            font-size: 14px;
        }

        .form-group input[type="text"],
        .form-group input[type="url"],
        .form-group input[type="number"] {
            width: 100%;
            padding: 10px 12px;
            background: #0f172a;
            border: 2px solid #334155;
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #22d3ee;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .save-btn {
            width: 100%;
            padding: 16px;
            font-size: 18px;
            margin-top: 30px;
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }

        .info-box h3 {
            color: #60a5fa;
            margin-bottom: 12px;
        }

        .info-box ul {
            list-style: none;
            padding-left: 0;
        }

        .info-box li {
            padding: 8px 0;
            color: #cbd5e1;
        }

        .info-box li:before {
            content: "• ";
            color: #3b82f6;
            font-weight: bold;
            margin-right: 8px;
        }

        .viewer-link {
            background: rgba(16, 185, 129, 0.1);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .viewer-link h3 {
            color: #10b981;
            margin-bottom: 12px;
        }

        .url-display {
            display: flex;
            gap: 12px;
            align-items: center;
            background: #0f172a;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .url-display input {
            flex: 1;
            background: transparent;
            border: none;
            color: #22d3ee;
            font-family: monospace;
            font-size: 14px;
        }

        .url-display input:focus {
            outline: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>⚙️ Painel Administrativo</h1>
                <p style="color: #94a3b8; margin-top: 5px;">Controle centralizado dos radares</p>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <div class="sync-status connecting" id="syncStatus">
                    <span class="sync-dot"></span>
                    <span id="syncText">Conectando...</span>
                </div>
                <button class="btn btn-primary" onclick="openViewer()">
                    🚀 Abrir Visualizador
                </button>
            </div>
        </div>

        <!-- Alerts -->
        <div class="alert alert-success" id="alertSaved">
            ✓ Configurações salvas! Todos os visualizadores atualizarão automaticamente.
        </div>

        <div class="alert alert-info" id="alertActivated">
            ⚡ Radar ativado! Mudança propagada para todos os computadores.
        </div>

        <!-- Preview dos Radares -->
        <div class="grid">
            <!-- Radar 1 Preview -->
            <div class="radar-preview" id="preview-radar1">
                <div class="preview-header">
                    <div class="preview-title">
                        📡 RADAR 1
                        <span class="badge" id="badge1" style="display: none;">ATIVO</span>
                    </div>
                    <div class="status-indicator" id="status-radar1">
                        <span class="status-dot loading"></span>
                        <span>Carregando...</span>
                    </div>
                </div>
                <div class="iframe-container">
                    <div class="loading-overlay" id="loading-radar1">
                        <div style="text-align: center;">
                            <div class="spinner"></div>
                            <p style="margin-top: 16px;">Carregando radar...</p>
                        </div>
                    </div>
                    <iframe id="iframe-radar1" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
                </div>
                <div class="preview-footer">
                    <span id="name-radar1">Radar 1</span>
                    <div class="preview-actions">
                        <span id="time-radar1" style="color: #94a3b8; font-size: 12px; margin-right: 8px;"></span>
                        <button class="btn-icon" onclick="forceReload('radar1')" title="Recarregar">🔄</button>
                        <button class="btn-icon" onclick="setActive('radar1')" title="Ativar">⚡</button>
                    </div>
                </div>
                
                <!-- Config Radar 1 -->
                <div class="config-section">
                    <h3>⚙️ Configurações</h3>
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="name1" value="Radar Mendanha">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="url1" value="https://plataforma-clima.dados.rio/radar/mendanha/reflectivity/mapa">
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="auto1" checked>
                        <label for="auto1" style="margin: 0;">Atualização automática</label>
                    </div>
                    <div class="form-group">
                        <label>Intervalo (minutos)</label>
                        <input type="number" id="interval1" value="5" min="1" max="60">
                    </div>
                </div>
            </div>

            <!-- Radar 2 Preview -->
            <div class="radar-preview" id="preview-radar2">
                <div class="preview-header">
                    <div class="preview-title">
                        📡 RADAR 2
                        <span class="badge" id="badge2" style="display: none;">ATIVO</span>
                    </div>
                    <div class="status-indicator" id="status-radar2">
                        <span class="status-dot loading"></span>
                        <span>Carregando...</span>
                    </div>
                </div>
                <div class="iframe-container">
                    <div class="loading-overlay" id="loading-radar2">
                        <div style="text-align: center;">
                            <div class="spinner"></div>
                            <p style="margin-top: 16px;">Carregando radar...</p>
                        </div>
                    </div>
                    <iframe id="iframe-radar2" sandbox="allow-same-origin allow-scripts allow-popups allow-forms"></iframe>
                </div>
                <div class="preview-footer">
                    <span id="name-radar2">Radar 2</span>
                    <div class="preview-actions">
                        <span id="time-radar2" style="color: #94a3b8; font-size: 12px; margin-right: 8px;"></span>
                        <button class="btn-icon" onclick="forceReload('radar2')" title="Recarregar">🔄</button>
                        <button class="btn-icon" onclick="setActive('radar2')" title="Ativar">⚡</button>
                    </div>
                </div>
                
                <!-- Config Radar 2 -->
                <div class="config-section">
                    <h3>⚙️ Configurações</h3>
                    <div class="form-group">
                        <label>Nome</label>
                        <input type="text" id="name2" value="Radar Alerta Rio">
                    </div>
                    <div class="form-group">
                        <label>URL</label>
                        <input type="url" id="url2" value="https://www.sistema-alerta-rio.com.br/upload/Mapa/mapaRadar.html">
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="auto2" checked>
                        <label for="auto2" style="margin: 0;">Atualização automática</label>
                    </div>
                    <div class="form-group">
                        <label>Intervalo (minutos)</label>
                        <input type="number" id="interval2" value="5" min="1" max="60">
                    </div>
                </div>
            </div>
        </div>

        <button class="btn btn-success save-btn" onclick="saveConfig()">
            💾 Salvar Todas as Configurações
        </button>

        <!-- Link do Visualizador -->
        <div class="viewer-link">
            <h3>🔗 Link do Visualizador</h3>
            <p style="color: #cbd5e1; margin-bottom: 12px;">
                Copie este link e abra em todos os computadores/TVs:
            </p>
            <div class="url-display">
                <input type="text" id="viewerUrl" readonly>
                <button class="btn btn-primary" onclick="copyViewerUrl()">
                    📋 Copiar
                </button>
            </div>
        </div>

        <!-- Info -->
        <div class="info-box">
            <h3>💡 Como usar:</h3>
            <ul>
                <li>Configure os radares acima (nome, URL, intervalo)</li>
                <li>Veja os previews dos radares ao vivo</li>
                <li>Clique em <strong>⚡</strong> para escolher qual radar exibir</li>
                <li>Todos os visualizadores atualizam automaticamente em tempo real</li>
                <li>Funciona em qualquer PC conectado à internet</li>
            </ul>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, onValue } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // ⚠️ CREDENCIAIS DO FIREBASE EMBUTIDAS NO CÓDIGO
        const firebaseConfig = {
            apiKey: "AIzaSyCpnDf40JQ3COptyNJFZnqj9niTn5iBDeY",
            authDomain: "coldgend.firebaseapp.com",
            databaseURL: "https://coldgend-default-rtdb.firebaseio.com",
            projectId: "coldgend"
        };

        let db = null;
        let configRef = null;
        let retryTimers = {};

        // Inicializa Firebase automaticamente
        initFirebase();

        function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getDatabase(app);
                configRef = ref(db, 'radarConfig');
                
                updateSyncStatus('online', 'Conectado ✓');
                
                onValue(configRef, (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        loadConfigFromFirebase(data);
                    }
                });
                
                setTimeout(() => {
                    loadRadar('radar1');
                    loadRadar('radar2');
                }, 500);
                
                console.log('✓ Firebase conectado automaticamente');
            } catch (error) {
                console.error('Erro ao conectar Firebase:', error);
                updateSyncStatus('offline', 'Erro de conexão');
            }
        }

        function loadConfigFromFirebase(data) {
            document.getElementById('name1').value = data.radar1.name;
            document.getElementById('url1').value = data.radar1.url;
            document.getElementById('auto1').checked = data.radar1.autoRefresh;
            document.getElementById('interval1').value = data.radar1.refreshInterval / 60000;

            document.getElementById('name2').value = data.radar2.name;
            document.getElementById('url2').value = data.radar2.url;
            document.getElementById('auto2').checked = data.radar2.autoRefresh;
            document.getElementById('interval2').value = data.radar2.refreshInterval / 60000;

            document.getElementById('name-radar1').textContent = data.radar1.name;
            document.getElementById('name-radar2').textContent = data.radar2.name;

            updateActiveRadar(data.global.activeRadar);
        }

        function updateActiveRadar(active) {
            ['radar1', 'radar2'].forEach(key => {
                const preview = document.getElementById(`preview-${key}`);
                const badge = document.getElementById(`badge${key.slice(-1)}`);
                
                if (key === active) {
                    preview.classList.add('active');
                    badge.style.display = 'inline-block';
                } else {
                    preview.classList.remove('active');
                    badge.style.display = 'none';
                }
            });
        }

        window.saveConfig = async function() {
            const config = {
                radar1: {
                    name: document.getElementById('name1').value,
                    url: document.getElementById('url1').value,
                    autoRefresh: document.getElementById('auto1').checked,
                    refreshInterval: parseInt(document.getElementById('interval1').value) * 60000
                },
                radar2: {
                    name: document.getElementById('name2').value,
                    url: document.getElementById('url2').value,
                    autoRefresh: document.getElementById('auto2').checked,
                    refreshInterval: parseInt(document.getElementById('interval2').value) * 60000
                },
                global: {
                    activeRadar: document.querySelector('.radar-preview.active')?.id.replace('preview-', '') || 'radar1',
                    lastUpdate: Date.now()
                }
            };

            try {
                await set(configRef, config);
                showAlert('alertSaved');
                
                document.getElementById('name-radar1').textContent = config.radar1.name;
                document.getElementById('name-radar2').textContent = config.radar2.name;
                
                loadRadar('radar1');
                loadRadar('radar2');
                
                console.log('✓ Configuração salva no Firebase');
            } catch (error) {
                console.error('Erro ao salvar:', error);
                alert('❌ Erro ao salvar configuração');
            }
        };

        window.setActive = async function(radarKey) {
            updateActiveRadar(radarKey);
            await saveConfig();
            showAlert('alertActivated');
        };

        function loadRadar(radarKey) {
            const iframe = document.getElementById(`iframe-${radarKey}`);
            const loading = document.getElementById(`loading-${radarKey}`);
            const status = document.getElementById(`status-${radarKey}`);
            const timeEl = document.getElementById(`time-${radarKey}`);
            const urlInput = document.getElementById(`url${radarKey.slice(-1)}`);

            const url = urlInput.value;
            if (!url) return;

            loading.style.display = 'flex';
            status.innerHTML = '<span class="status-dot loading"></span><span>Carregando...</span>';

            if (retryTimers[radarKey]) clearTimeout(retryTimers[radarKey]);

            const timeout = setTimeout(() => {
                loading.style.display = 'none';
                status.innerHTML = '<span class="status-dot offline"></span><span>Offline</span>';
            }, 15000);

            iframe.onload = () => {
                clearTimeout(timeout);
                loading.style.display = 'none';
                status.innerHTML = '<span class="status-dot online"></span><span>Online</span>';
                timeEl.textContent = new Date().toLocaleTimeString();
            };

            iframe.onerror = () => {
                clearTimeout(timeout);
                loading.style.display = 'none';
                status.innerHTML = '<span class="status-dot offline"></span><span>Offline</span>';
            };

            if (iframe.src !== url) {
                iframe.src = url;
            } else {
                try {
                    iframe.contentWindow?.location.reload();
                } catch (e) {
                    iframe.src = url;
                }
            }
        }

        window.forceReload = function(radarKey) {
            loadRadar(radarKey);
        };

        function showAlert(id) {
            const alert = document.getElementById(id);
            alert.classList.add('show');
            setTimeout(() => alert.classList.remove('show'), 3000);
        }

        function updateSyncStatus(status, text) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            
            syncStatus.className = `sync-status ${status}`;
            syncText.textContent = text;
        }

        window.openViewer = function() {
            const viewerUrl = document.getElementById('viewerUrl').value;
            window.open(viewerUrl, '_blank');
        };

        window.copyViewerUrl = function() {
            const input = document.getElementById('viewerUrl');
            input.select();
            document.execCommand('copy');
            
            const btn = event.target;
            btn.textContent = '✓ Copiado!';
            setTimeout(() => btn.textContent = '📋 Copiar', 2000);
        };

        // Calcula URL do viewer automaticamente
        function getViewerUrl() {
            const currentUrl = window.location.href;
            // Remove index.html ou admin.html se existir
            const baseUrl = currentUrl.replace(/\/(index|admin)\.html.*$/, '/');
            return baseUrl + (baseUrl.endsWith('/') ? '' : '/') + 'viewer.html';
        }
        
        document.getElementById('viewerUrl').value = getViewerUrl();
    </script>
</body>
</html>